name: Deploy Obsidian Remote (Docker Compose)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "docker-compose.yml"
      - "authelia/**"
      - "setup-passkey.sh"
      - ".github/workflows/deploy.yml"
      - "README.md"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Safe debug (does NOT print key)
      - name: Debug deploy inputs (safe)
        shell: bash
        env:
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USERNAME }}
          KEY:  ${{ secrets.VPS_SSH_KEY }}
        run: |
          echo "HOST=$HOST"
          echo "USER=$USER"
          if [ -z "$KEY" ]; then
            echo "SSH KEY: NOT SET"
          else
            echo "SSH KEY: SET (length=${#KEY})"
          fi
          echo "PORT=${{ secrets.VPS_PORT || 22 }}"

      - name: Ensure target dir exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            mkdir -p /opt/obsidianRemote/config
            ls -la /opt/obsidianRemote

      - name: Upload docker-compose.yml to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "docker-compose.yml,setup-passkey.sh,authelia"
          target: "/opt/obsidianRemote/"
          overwrite: true

      - name: Setup Authelia (first time or if config missing)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            cd /opt/obsidianRemote
            
            # Make setup script executable
            chmod +x setup-passkey.sh
            
            # Only run setup if it hasn't been configured yet
            if grep -q "CHANGE_THIS_TO_A_RANDOM_STRING" authelia/configuration.yml 2>/dev/null; then
              echo "Running initial Authelia setup..."
              AUTH_DOMAIN="${{ secrets.AUTH_DOMAIN }}" \
              AUTH_USERNAME="${{ secrets.AUTH_USERNAME }}" \
              AUTH_PASSWORD="${{ secrets.AUTH_PASSWORD }}" \
              AUTH_EMAIL="${{ secrets.AUTH_EMAIL }}" \
              ./setup-passkey.sh
            else
              echo "Authelia already configured, skipping setup..."
            fi

      - name: Pull + restart Obsidian Remote
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            cd /opt/obsidianRemote

            # Make sure the NPM network exists (if you use Nginx Proxy Manager)
            docker network ls | grep -q npm_default || docker network create npm_default

            # Remove the corrupted container and clean up orphans
            docker stop obsidian_remote || true
            docker rm obsidian_remote || true
            docker-compose down --remove-orphans || true

            # Clear nginx config to regenerate for HTTP-only (preserves vault data)
            rm -rf /opt/obsidianRemote/config/data/nginx /opt/obsidianRemote/config/log/nginx

            # Bring it up
            docker-compose pull
            docker-compose up -d

            # Verify
            docker ps --filter "name=obsidian_remote" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
