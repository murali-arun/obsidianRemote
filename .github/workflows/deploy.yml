name: Deploy to VPS via Docker

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'index.html'
      - 'vite.config.js'
      - 'package.json'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Verify dist/ exists
        run: |
          ls -la
          ls -la dist

      # Safe debug (does NOT print key)
      - name: Debug deploy inputs (safe)
        shell: bash
        env:
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USERNAME }}
          KEY:  ${{ secrets.VPS_SSH_KEY }}
        run: |
          echo "HOST=$HOST"
          echo "USER=$USER"
          if [ -z "$KEY" ]; then
            echo "SSH KEY: NOT SET"
          else
            echo "SSH KEY: SET (length=${#KEY})"
          fi
          echo "PORT=${{ secrets.VPS_PORT || 22 }}"

      # Ensure target directory exists on VPS
      - name: Ensure target dir exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            mkdir -p /opt/template-static
            ls -la /opt/template-static

      - name: Upload dist/ to VPS via SCP (over SSH)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "dist/*"
          target: "/opt/template-static/"
          strip_components: 1
          overwrite: true

      - name: Deploy and restart Docker container
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            # Create nginx config
            cat > /opt/template-static-nginx.conf << 'EOF'
            server {
                listen 80;
                server_name localhost;
                
                root /usr/share/nginx/html;
                index index.html;
                
                # Gzip compression
                gzip on;
                gzip_vary on;
                gzip_min_length 1024;
                gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
                
                # SPA routing - serve index.html for all routes
                location / {
                    try_files $uri $uri/ /index.html;
                }
                
                # Security headers
                add_header X-Frame-Options "SAMEORIGIN" always;
                add_header X-Content-Type-Options "nosniff" always;
                add_header X-XSS-Protection "1; mode=block" always;
                
                # Cache static assets
                location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
                
                location ~* \.(css|js|woff|woff2|ttf|eot)$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
                
                # Deny access to hidden files
                location ~ /\. {
                    deny all;
                    access_log off;
                    log_not_found off;
                }
            }
            EOF

            # Create docker-compose file
            cat > /opt/template-static-compose.yml << 'EOF'
            version: '3.8'

            services:
              template-static:
                image: nginx:alpine
                container_name: base-template-arun
                volumes:
                  - /opt/template-static:/usr/share/nginx/html:ro
                  - /opt/template-static-nginx.conf:/etc/nginx/conf.d/default.conf:ro
                networks:
                  - npm_default
                restart: unless-stopped

            networks:
              npm_default:
                external: true
            EOF

            # Start or restart the container
            cd /opt
            docker-compose -f template-static-compose.yml down || true
            docker-compose -f template-static-compose.yml up -d
            
            # Verify container is running
            docker ps | grep base-template-arun
