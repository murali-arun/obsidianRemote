name: Deploy Obsidian Remote (Docker Compose)

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "docker-compose.yml"
      - ".github/workflows/deploy.yml"
      - "README.md"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Safe debug (does NOT print key)
      - name: Debug deploy inputs (safe)
        shell: bash
        env:
          HOST: ${{ secrets.VPS_HOST }}
          USER: ${{ secrets.VPS_USERNAME }}
          KEY:  ${{ secrets.VPS_SSH_KEY }}
        run: |
          echo "HOST=$HOST"
          echo "USER=$USER"
          if [ -z "$KEY" ]; then
            echo "SSH KEY: NOT SET"
          else
            echo "SSH KEY: SET (length=${#KEY})"
          fi
          echo "PORT=${{ secrets.VPS_PORT || 22 }}"

      - name: Ensure target dir exists
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            mkdir -p /opt/obsidianRemote/config
            ls -la /opt/obsidianRemote

      - name: Upload docker-compose.yml to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          source: "docker-compose.yml"
          target: "/opt/obsidianRemote/"
          overwrite: true

      - name: Pull + restart Obsidian Remote
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            cd /opt/obsidianRemote

            # Make sure the NPM network exists (if you use Nginx Proxy Manager)
            docker network ls | grep -q npm_default || docker network create npm_default

            # Bring it up
            docker compose pull
            docker compose up -d

            # Verify
            docker ps --filter "name=obsidian_remote" --format "table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}"
